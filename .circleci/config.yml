version: 2.1

parameters:
  cache_key:
    type: string
    default: 1 # Bump this number to invalidate the cache

jobs:
  build:
    working_directory: ~/bikeindex/bike_index
    parallelism: 2
    shell: /bin/bash --login
    environment:
      RAILS_ENV: test
      NODE_ENV: test
      RACK_ENV: test
      COVERAGE: true
      DISABLE_SPRING: true
      TRANSLATION_BRANCH: main
      TZ: /usr/share/zoneinfo/America/Chicago

    docker:
      - image: cimg/ruby:2.7.5-node
        environment:
          PGHOST: 127.0.0.1
          PGUSER: root
          PSQL_PAGER: ""
      - image: cimg/postgres:13.5-postgis
        environment:
          POSTGRES_USER: root
          POSTGRES_DB: bikeindex_test
          POSTGRES_PASSWORD: ""
      - image: redis:4.0.9

    # The resource_class feature allows configuring CPU and RAM resources for each job. Different resource classes are available for different executors. https://circleci.com/docs/2.0/configuration-reference/#resourceclass
    resource_class: large

    steps:
      - run: echo "\n\ncache version - << pipeline.parameters.cache_key >> -- used {{ << pipeline.parameters.cache_key >> }}\n\n"

      - add_ssh_keys:
          fingerprints:
            - "b7:01:89:de:d8:f8:77:cc:9e:5a:ca:ee:0c:24:57:13"

