#!/usr/bin/env ruby
require "fileutils"
include FileUtils

# path to your application root.
APP_ROOT = File.expand_path("..", __dir__)

def system!(*args)
  system(*args) || abort("\n== Command #{args} failed ==")
end

chdir APP_ROOT do
  # Conductor workspace setup
  if ENV["CONDUCTOR_ROOT_PATH"]
    root = ENV["CONDUCTOR_ROOT_PATH"]
    puts "== Setting up Conductor workspace =="

    # Copy .env.test from root repo
    env_test = File.join(root, ".env.test")
    if File.exist?(env_test)
      puts "Copying .env.test from #{root}..."
      cp env_test, ".env.test"
    end

    # Copy .env.conductor_dev from root repo
    env_dev = File.join(root, ".env.conductor_dev")
    if File.exist?(env_dev)
      puts "Copying .env.conductor_dev from #{root}..."
      cp env_dev, ".env.development"
    end

    # Symlink storage directory for Active Storage
    root_storage = File.join(root, "storage")
    if Dir.exist?(root_storage)
      puts "Symlinking storage from #{root_storage}..."
      rm_rf "storage"
      ln_sf root_storage, "storage"
    else
      puts "Creating storage directory at #{root_storage}..."
      mkdir_p root_storage
      ln_sf root_storage, "storage"
    end

    # Copy Facebook VCR cassettes
    fb_cassettes = File.join(root, "spec/vcr_cassettes/facebook")
    if Dir.exist?(fb_cassettes)
      puts "Copying spec/vcr_cassettes/facebook from #{root}..."
      mkdir_p "spec/vcr_cassettes/facebook"
      Dir.glob(File.join(fb_cassettes, "*")).each { |f| cp f, "spec/vcr_cassettes/facebook/" }
    end
  end

  puts "== Installing dependencies =="
  system! "gem install bundler --conservative"
  system("bundle check") || system!("bundle install")

  puts "== Starting redis so database can be migrated =="
  system "redis-server &"

  # Install JavaScript dependencies
  system('npm install')

  # Copy StravaSearch node_modules from root repo for Conductor workspaces
  if ENV["CONDUCTOR_ROOT_PATH"]
    root_node_modules = File.join(ENV["CONDUCTOR_ROOT_PATH"], "vendor/strava_search/node_modules")
    if Dir.exist?(root_node_modules)
      puts "Copying strava_search node_modules from #{root_node_modules}..."
      system("cp -r #{root_node_modules} vendor/strava_search/node_modules")
    end
  end

  puts "\n== Preparing database =="

  # NOTE: only loading db:schema on primary, because primary_replica is the same db in dev
  system "bin/rake db:create db:schema:load:primary db:schema:load:analytics db:migrate"
  system "bin/rake import_manufacturers_csv"
  system "bin/rake import_primary_activities_csv"

  puts "\n== Seeding database =="
  system "bin/rake db:seed"

  puts "\n== Preparing test database (including parallelism) =="
  system "bin/rake parallel:prepare"

  puts "\n== Removing old logs and tempfiles =="
  system! "bin/rails log:clear tmp:clear"

  puts "\n Running update to prepare typeahead"
  system "bin/rake reset_autocomplete"

  puts "\n== Restarting application server =="
  system! "bin/rails restart"
end
