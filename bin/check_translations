#!/usr/bin/env bash

if [ -n "$1" ]; then
  export TRANSLATION_IO_API_KEY="$1"
fi

set -e

CYAN="\033[0;36m"
YELLOW="\033[0;33m"
RED="\033[0;31m"
GREEN="\033[0;32m"
NONE="\033[0m"

output() {
  printf "\n${1}${2}${NONE}\n\n"
}

# Only alias git on macOS (local dev); CI has git on a different path
if [ -z "$CI" ] && [ -f /usr/local/bin/git ]; then
  alias git=/usr/local/bin/git
fi

output "${CYAN}" "Checking Translations"

# Determine if we're on the sync branch (full sync vs lightweight check)
on_sync_branch=false
if [ -n "$TRANSLATION_BRANCH" ] && git branch --list | grep --silent "^* ${TRANSLATION_BRANCH}$"; then
  on_sync_branch=true
fi

if [ "$on_sync_branch" = true ] && [ -n "$TRANSLATION_IO_API_KEY" ]; then
  output "${CYAN}" "Full sync: on ${TRANSLATION_BRANCH} with API key"
  echo bundle exec rake translation:sync_and_purge prepare_translations
  bundle exec rake translation:sync_and_purge prepare_translations

  output "${YELLOW}" "Stashing translation.io timestamp file"
  set -x
  git stash -- config/locales/.translation_io
  git status --short
  # Reset the migrations, in case of postgres artifacts changing things
  git checkout HEAD db/
  set +x
else
  output "${CYAN}" "Lightweight check: running prepare_translations"
  echo bundle exec rake prepare_translations
  bundle exec rake prepare_translations
fi

if [[ -z "$(git --no-pager diff)" ]]; then
  output "${GREEN}" "No uncommitted translations. Done."
  exit 0
else
  output "${RED}" "Uncommitted Translations"
  git --no-pager diff

  if [ -n "$CI" ] && [ "$on_sync_branch" = true ]; then
    output "${YELLOW}" "On CI — creating translation sync PR"

    # Check for existing open translation sync PRs
    existing_pr=$(gh pr list --head "translations-sync" --state open --json number --jq '.[0].number' 2>/dev/null || true)
    if [ -n "$existing_pr" ]; then
      output "${YELLOW}" "Translation sync PR already exists: #${existing_pr} — skipping PR creation"
      exit 1
    fi

    branch_name="translations-sync-$(date +%Y%m%d%H%M%S)"

    git config user.name "github-actions[bot]"
    git config user.email "github-actions[bot]@users.noreply.github.com"

    git checkout -b "$branch_name"
    git stash pop || true
    git add config/locales/
    git commit -m "translations sync"
    git push origin "$branch_name"

    gh pr create \
      --title "translations sync" \
      --body "Automated translation sync from CI. Merge this PR then re-run the failed build." \
      --base main \
      --head "$branch_name"

    output "${YELLOW}" "PR created. Build will fail until the PR is merged."
  fi

  exit 1
fi
