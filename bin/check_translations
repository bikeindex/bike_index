#!/usr/bin/env bash

if [ -n "$1" ]; then
  export TRANSLATION_IO_API_KEY="$1"
fi

set -e

CYAN="\033[0;36m"
YELLOW="\033[0;33m"
RED="\033[0;31m"
GREEN="\033[0;32m"
NONE="\033[0m"

output() {
  printf "\n${1}${2}${NONE}\n\n"
}

# Only alias git on macOS (local dev); CI has git on a different path
if [ -z "$CI" ] && [ -f /usr/local/bin/git ]; then
  alias git=/usr/local/bin/git
fi

output "${CYAN}" "Checking Translations"

# Quit as success if not on the branch to be synced
if ! git branch --list | grep --silent "^* ${TRANSLATION_BRANCH}$"; then
  output "${GREEN}" "Skipping: Not on TRANSLATION_BRANCH: ${TRANSLATION_BRANCH}"
  exit 0
fi

echo bundle exec rake translation:sync_and_purge prepare_translations
bundle exec rake translation:sync_and_purge prepare_translations

output "${YELLOW}" "Stashing translation.io timestamp file"
set -x
git stash -- config/locales/.translation_io
git status --short
# Reset the migrations, in case of postgres artifacts changing things
git checkout HEAD db/
set +x

if [[ -z "$(git --no-pager diff)" ]]; then
  output "${GREEN}" "No uncommitted translations. Done."
  exit 0
else
  output "${RED}" "Uncommitted Translations"
  git --no-pager diff

  if [ -n "$CI" ]; then
    output "${YELLOW}" "On CI — creating translation sync PR"

    # Check for existing open translation sync PRs
    existing_pr=$(gh pr list --head "translations-sync" --state open --json number --jq '.[0].number' 2>/dev/null || true)
    if [ -n "$existing_pr" ]; then
      output "${YELLOW}" "Translation sync PR already exists: #${existing_pr} — skipping PR creation"
      exit 1
    fi

    branch_name="translations-sync-$(date +%Y%m%d%H%M%S)"

    git config user.name "github-actions[bot]"
    git config user.email "github-actions[bot]@users.noreply.github.com"

    git checkout -b "$branch_name"
    git stash pop || true
    git add config/locales/
    git commit -m "translations sync"
    git push origin "$branch_name"

    gh pr create \
      --title "Automated translations sync from CI" \
      --body "" \
      --base main \
      --head "$branch_name"

    output "${YELLOW}" "PR created. Build will fail until the PR is merged."
  fi

  exit 1
fi
