- if @organization.enabled?("graduated_notifications") && @bike.graduated?(@organization)
  %h5.mt-4
    %strong.text-warning This is a graduated #{@bike.type}
    %span.text-dark
      \- it is no longer registered with #{@organization.short_name}
    %em.small.less-strong
      it was registered with #{@organization.short_name} previously
.card.organized-access-panel
  .card-block
    .card-title
      .row
        .col-xs-6
          %h3.header-font-alt
            %span.hidden-sm-down
              = @organization.short_name
            = translation(".access_panel")
        .col-xs-6
          - if @bike.unregistered_parking_notification?
            %p.strong.text-warning.text-right
              = translation(".unregistered_parking_notification")
          - elsif organization_registered?
            %p.text-success.text-right
              %span.hidden-md-down
                = translation(".bike_is_registered", bike_type: @bike.type, org_name: @organization.short_name)
              %span.hidden-lg-up
                = translation(".is_registered", org_name: @organization.short_name)
          - else
            %p.text-warning.text-right
              %span.hidden-md-down
                = translation(".bike_is_not_registered_html", bike_type: @bike.type, org_name: @organization.short_name).html_safe
              %span.hidden-lg-up
                = translation(".is_not_registered_html", org_name: @organization.short_name).html_safe
    .card-body
      .row
        - if @organization.ambassador? && @bike.current_stolen_record.present?
          .col-xs-12.mb-2
            .text-right.less-strong
              = translation(".as_a_bikeindex_ambassador_html").html_safe

              = link_to translation(".mark_bike_recovered"), edit_bike_recovery_url(bike_id: @bike.id, token: @bike.current_stolen_record.find_or_create_recovery_link_token), class: "btn btn-success btn-sm"

        .mb-2{class: display_unstolen_notification_form? ? "col-md-7" : "col-sm-12"}
          %table.table-list
            %tbody
              %tr
                %td= translation(".permission")
                %td
                  - if organization_authorized?
                    = translation(".org_can_edit_bike", org_name: @organization.short_name, bike_type: @bike.type)
                    - if @bike.can_edit_claimed_organizations.pluck(:id).include?(@organization.id)
                      %em.small
                        = translation(".organization_can_edit_after_claimed", bike_type: @bike.type)
                    - if user_can_edit?
                      = link_to translation(".edit"), edit_bike_path(@bike, edit_template: @bike.default_edit_template), class: "btn btn-success btn-sm float-right"
                  - else
                    %em.small.less-strong
                      = translation(".org_cannot_edit", org_name: @organization.short_name)
              - if @organization.enabled?("bike_stickers")
                %tr
                  %td
                    = translation(".sticker")
                  %td
                    - stickers = @bike.bike_stickers.reorder(claimed_at: :desc)
                    - if stickers.any?
                      %ul
                        - stickers.each do |bike_sticker|
                          %li
                            - if bike_sticker.organization.present? && bike_sticker.organization == @organization
                              = link_to bike_sticker.pretty_code, edit_organization_sticker_path(id: bike_sticker.code, organization_id: bike_sticker.organization&.to_param)
                            - else
                              = bike_sticker.pretty_code
                            - if bike_sticker.claimed_at.present?
                              %small.less-strong
                                claimed
                                %em.localizeTime.preciseTime
                                  = l bike_sticker.claimed_at, format: :convert_time
                    .small.text-right
                      %a.less-strong{href: "#", style: "opacity: 0.8; text-align: right;", data: {toggle: "modal", target: "#assignStickerModal"}}
                        = translation(".link_sticker")
              - if @bike.unregistered_parking_notification?
                %tr
                  %td{colspan: 2, style: "text-align: center; font-size: 1rem;"}
                    = translation(".added_to_track_parking_notification", bike_type: @bike.type)
              - elsif organization_registered? # Only display information about the bike if bike is registered through org
                - if @organization.parent?
                  %tr
                    %td
                      = translation(".organization_registered")
                    %td
                      - if @bike.creation_organization == @organization
                        %small= @bike.creation_organization.name
                      - else
                        %em.small= translation(".organization_child")
                        = @bike.creation_organization&.name
                %tr
                  %td= translation(".owner_name")
                  %td= @bike.owner_name
                %tr
                  %td= translation(".owner_email")
                  %td= @bike.owner_email
                %tr
                  %td= translation(".registered")
                  %td
                    %span.localizeTime
                      = l @bike.created_at, format: :convert_time
                %tr
                  %td= translation(".claimed")
                  %td
                    - if @bike.claimed?
                      = check_mark
                      %small.localizeTime.ml-2= l current_ownership.claimed_at, format: :convert_time
                %tr
                  %td= translation(".creator")
                  %td
                    = @bike.creator&.display_name
                %tr
                  %td= translation(".creation_source")
                  %td
                    %em
                      = origin_display(@bike.creation_description)
                      - unless current_ownership.initial?
                        %span.localizeTime= l current_ownership.created_at, format: :convert_time
                    - if display_original_ownership?
                      %small.less-strong.ml-2
                        = translation(".initial_registration")
                        %em
                          = origin_display(original_ownership.creation_description)

                -# Bike Stickers are handled separately, so skip it
                - (@organization.additional_registration_fields - ["reg_bike_sticker"]).each do |reg_field|
                  - bike_attr = OrganizationFeature.reg_field_to_bike_attrs(reg_field)
                  - if bike_attr == "address"
                    %tr
                      %td= translation(".address")
                      %td
                        - address = @bike.registration_address
                        - if @bike.valid_mailing_address?
                          %small= render UI::AddressDisplay::Component.new(address_record: BikeServices::CalculateLocation.registration_address_record(@bike), visible_attribute: :street)
                        - else
                          -# Don't show address if it's the organizations default address
                          - unless address == @organization.default_location&.address_hash
                            - address.except("latitude", "longitude", "country").each do |k, v|
                              %span.less-strong
                                #{k == "address" ? "street" : k}:
                              = v
                              %br
                          %span.text-warning
                            %small invalid address
                        - address_source = BikeServices::CalculateLocation.registration_address_source(@bike)
                        - if address_source.present?
                          %small{class: "less-strong tw:mt-2 tw:block"}
                            %em
                              Address source:
                            = address_source.to_s&.humanize
                  - else
                    %tr
                      %td
                        = "#{(bike_attr || reg_field)&.humanize(keep_id_suffix: true)}"
                      %td
                        - if bike_attr == "organization_affiliation"
                          = @bike.organization_affiliation(@organization)&.humanize
                        - elsif bike_attr == "student_id"
                          = @bike.student_id(@organization)
                        - else
                          = @bike.send(bike_attr)

                - if @organization.enabled?("avery_export")
                  %tr
                    %td= translation(".avery_exportable")
                    %td
                      - if @bike.avery_exportable?
                        %span.text-success
                          = translation(".is_true")
                      - else
                        %span.text-danger
                          = translation(".is_false")
                        %small.em
                          - unless @bike.owner_name.present?
                            = translation(".missing_owner_name")
                          - unless @bike.valid_mailing_address?
                            = translation(".missing_address")

                - if @organization.enabled?("model_audits")
                  %tr
                    %td= translation(".model_audit")
                    %td
                      - model_audit = @bike.model_audit if @bike.model_audit_id.present?
                      - organization_model_audit = OrganizationModelAudit.where(organization_id: @organization.id, model_audit_id: @bike.model_audit_id).first if model_audit.present?
                      - if organization_model_audit.present?
                        = link_to model_audit_display(model_audit), organization_model_audit_path(model_audit, organization_id: @organization.to_param)
                        %span.ml-2{class: status_display_class(organization_model_audit.certification_status)}
                          = organization_model_audit.certification_status_humanized
                      - else
                        %span.less-strong= translation(".not_audited")


          - if !organization_registered? # Apologize, bike isn't organizations
            %p.less-strong.mt-4
              %em
                = translation(".unable_to_display_additional_information", bike_type: @bike.type, org_name: @organization.name)
        - if display_unstolen_notification_form?
          .col-md-5.unstolen-notification-box
            %p.mb-2
              %em= translation(".bike_not_marked_stolen", bike_type: @bike.type_titleize)
              %strong= translation(".believe_it_is_anyway")
            - if @bike.contact_owner?(@user)
              - redirect = new_session_url(return_to: bike_path(@bike, params: {contact_owner: true})) unless @user.present?
              #write_them_a_message.collapse{class: ("in" unless @contact_owner_open), data: {redirect: redirect}}
                %a{href: '#new_stolen_message', 'aria-controls' => 'new_stolen_message', 'data-toggle' => 'collapse'}
                  = translation(".write_a_message")
                = translation(".contact_the_owner_it_is_stolen", bike_type: @bike.type)

              .collapse#new_stolen_message{class: ("in" if @contact_owner_open)}
                - @stolen_notification ||= StolenNotification.new(bike: @bike, sender: @user)
                = form_for @stolen_notification do |f|
                  = f.hidden_field :bike_id, value: @bike.id
                  - if @user.ambassador?
                    = f.text_area :message, required: true, value: @stolen_notification.default_message, rows: 6, class: "form-control"
                  - else
                    = f.text_area :message, required: true, placeholder: translation(".where_did_you_see_this_bike", bike_type: @bike.type), rows: 6, class: "form-control"
                  = f.text_field :reference_url, placeholder: translation(".link_url_for_online_sighting"), class: "form-control additional-field"

                  .send-message
                    = f.submit translation(".send_message"), class: 'btn btn-primary btn-lg'

              - if @bike.phoneable_by?(@user)
                %p.phoneable-by.mt-4
                  = translation(".or_call_owner_html").html_safe
                  = phone_link(@bike.phone)
            - else
              %p
                = translation(".user_revoked_permission_html").html_safe
              %p
                = support_link = link_to(translation(".support_email"), "mailto:#{translation('.support_email')}")
                = translation(".email_to_deal_with_this_html", support_link: support_link).html_safe

      -# Additional law enforcement information
      - if @organization.enabled?("additional_registrations_information")
        .row.law-enforcement-wrapper.mt-4
          .col-xs-12.mt-2
            %p.mt-2.mb-2
              = translation(".additional_registrations_information")
              %em.less-strong.hidden-md-down
                = translation(".additional_registrations_information_visible_because", org_name: @organization.short_name)
            %table.table.table-striped.table-bordered.table-sm.without-exterior-border
              %tbody
                %thead
                  %th
                    = translation(".additional_registrations_registered_at")
                  %th
                    = translation(".creation_source")
                  %th

                - other_user_bikes.limit(25).each do |other_bike|
                  %tr
                    %td
                      %span.localizeTime
                        = l other_bike.created_at, format: :convert_time
                    %td
                      %em.less-strong
                        = origin_display(@bike.creation_description)
                    %td
                      - if other_bike.id == @bike.id
                        %em.less-strong= translation(".additional_registrations_this_bike", bike_type: @bike.type)
                      - else
                        = link_to organized_bike_text(other_bike, skip_creation: true), bike_path(other_bike)
            - if other_user_bikes_count > 25
              %p.text-center.less-strong.m-0
                User has
                = number_display(other_user_bikes_count)
                registrations, only 25 most recent shown.

        - if duplicate_bikes.any?
          %p.mt-2.mb-2
            = translation(".additional_registrations_potential_duplicates")
            - @bike.normalized_serial_segments.considered_for_duplicate.each do |normalized_segment|
              %code= normalized_segment.segment
          %table.table.table-striped.table-bordered.table-sm.without-exterior-border
            %tbody
              - duplicate_bikes.each do |duplicate_bike|
                %tr
                  %td
                    %span.localizeTime
                      = l duplicate_bike.created_at, format: :convert_time
                  %td
                    = link_to organized_bike_text(duplicate_bike), bike_path(duplicate_bike)
                    %small.less-strong
                      = duplicate_bike.normalized_serial_segments.considered_for_duplicate.pluck(:segment).join(", ")
      -# TODO: add translations
      -# if the bike was initially an unregistered parking notification, but no longer is, show that information
      - if @bike.creator_unregistered_parking_notification? && !@bike.unregistered_parking_notification? && @bike.parking_notifications.reorder(:created_at).first.organization_id == @organization.id
        - unregistered_parking_notification = @bike.parking_notifications.reorder(:created_at).first
        .small
          %em
            %span.text-warning
              Bike originally registered by an
              = link_to unregistered_parking_notification.kind_humanized.downcase, organization_parking_notification_path(unregistered_parking_notification, organization_id: unregistered_parking_notification.organization.to_param), class: "text-warning text-underline"
              notification
            - if @bike.status == "with_owner"
              but was sent to a new owner, so is now a standard #{@bike.type} on Bike Index.


      - if @bike.impound_records.resolved.where(organization_id: @organization.id).any?
        %p
          %strong Previously impounded
          \- #{link_to "view impound records", organization_impound_records_path(organization_id: @organization.to_param, search_bike_id: @bike.id, search_status: "all")}!

- if @organization.enabled?("graduated_notifications")
  - graduated_notifications = @bike.organization_graduated_notifications(@organization).order(id: :desc)
  - if graduated_notifications.any?
    .parking-notifications-wrap
      %h3.mt-2.mb-3 Graduated notifications
      = render partial: "/organized/graduated_notifications/table", locals: {graduated_notifications: graduated_notifications, skip_email: true, render_remaining_at: true}


- if @organization.enabled?("parking_notifications")
  - parking_notifications = @organization.parking_notifications.where(bike_id: @bike.id).order(id: :desc)

  .parking-notifications-wrap
    .row.mt-2.mb-2
      .col-xs-8.col-md-6
        %h3.uncap
          Parking notifications
      .col-xs-4.col-md-6
        .text-right
          %em
            = link_to organization_parking_notifications_path(organization_id: @organization.to_param, search_bike_id: @bike.id, search_status: "all") do
              view map
              .d-none.d-md-inline
                of
                = "notifications".pluralize(parking_notifications.count)
    - if @bike.status_impounded?
      - impound_record = @bike.current_impound_record&.organization_id == @organization.id ? @bike.current_impound_record : nil
      %h3.uncap.mt-2
        %span.text-danger
          #{@bike.type_titleize} is
          - if @bike.current_impound_record&.organization&.id == @organization.id
            impounded!
          - else
            impounded by #{@bike.current_impound_record&.organized? ? @bike.current_impound_record.organization.name : "an individual"}!
        - if impound_record.present?
          = link_to "Impound record ##{impound_record.display_id}", organization_impound_record_path(impound_record.display_id, organization_id: @organization.to_param)
          %em.small created by this impound notification:

    -# The parking notification that impounded the bike is never current - but we want to show it separately
    - current_impound_notification = parking_notifications.impound_notification.where(impound_record_id: impound_record&.id).first
    - if current_impound_notification.present?
      = render partial: "/organized/parking_notifications/table", locals: {parking_notifications: [current_impound_notification], skip_bike: true, skip_map_cell: true, render_address: true, skip_resolved: true, hide_status: true}
      .mt-4{style: "padding-bottom: 12px;"}

    - resolved_notifications = parking_notifications.resolved.where.not(id: current_impound_notification&.id)
    %p{style: "margin-top: -12px;"}
      -# Gotta include the current impound notification if it's present
      - current_count = parking_notifications.current.count
      - current_count += 1 if current_impound_notification.present?
      #{pluralize(number_with_delimiter(current_count), "current notification")},

      - if resolved_notifications.count > 0
        \-
        %a{href: "#resolvedParkingNotificationTable", "aria-controls" => "resolvedParkingNotificationTable", "data-toggle" => "collapse"}
          show
          = pluralize number_with_delimiter(resolved_notifications.count), "resolved notification"
      - else
        %span.less-strong 0 resolved notifications
      for #{@bike.type}
    - if parking_notifications.current.any?
      = render partial: "/organized/parking_notifications/table", locals: {parking_notifications: parking_notifications.current, skip_bike: true, skip_map_cell: true, render_address: true, skip_resolved: true}

    - if resolved_notifications.any?
      .collapse#resolvedParkingNotificationTable
        %p.mb-0
          %strong Resolved notifications
        = render partial: "/organized/parking_notifications/table", locals: {parking_notifications: resolved_notifications.limit(10), skip_bike: true, skip_map_cell: true, render_address: true}

    - unless @bike.status_impounded?
      - parking_notification_open = params[:parking_notification].present?

      .text-center#openNewParkingNotification.collapse{class: (parking_notification_open ? "" : "in")}
        %a.btn.btn-primary.btn-lg{href: "#newParkingNotificationFields"}
          New parking notification

      #newParkingNotificationFields.collapse{class: (parking_notification_open ? "in" : "") }
        %hr
        - parking_notification_present = @parking_notification.present?
        - @parking_notification ||= ParkingNotification.new(bike_id: @bike.id, organization: @organization, use_entered_address: false)
        - unless parking_notification_present
          / We only want to assign is_repeat if creating a new parking notification
          - @parking_notification.is_repeat = @parking_notification.likely_repeat?
          - @parking_notification.set_location_from_organization
        - @parking_notification.kind ||= @parking_notification.potential_initial_record&.kind || ParkingNotification.kinds.first

        = form_for @parking_notification, url: organization_parking_notifications_path(organization_id: @organization) do |f|
          = f.hidden_field :bike_id
          = f.hidden_field :latitude, class: "parkingLocation-latitude"
          = f.hidden_field :longitude, class: "parkingLocation-longitude"
          = f.hidden_field :accuracy, class: "parkingLocation-accuracy"
          .mt-4.text-center
            - if @parking_notification.can_be_repeat?
              .btn-group{role: "group", "aria-label" => "Repeat notice", data: {toggle: "buttons"}}
                %label.btn.btn-secondary{class: (@parking_notification.is_repeat ? "" : "active")}
                  = f.radio_button :is_repeat, false
                  First notice
                %label.btn.btn-secondary{class: (@parking_notification.is_repeat ? "active" : ""), disabled: !@parking_notification.can_be_repeat?}
                  = f.radio_button :is_repeat, true
                  -# We have to add 1 on the repeat because this hasn't been created yet
                  Repeat ##{@parking_notification.earlier_bike_notifications.count} of earlier notification

          .row.mt-4
            .col-md-6
              .form-group
                = f.label :message, "Optional message to send to user"
                = f.text_area :message, placeholder: "Optional", class: 'form-control'
            .col-md-6
              .form-group
                %p{style: "margin-bottom: 0;"} Notification because
                - ParkingNotification.kinds.each do |kind|
                  %label.radio-inline.mr-2
                    = f.radio_button :kind, kind
                    = ParkingNotification.kinds_humanized[kind.to_sym]

          .row
            .col-sm-6.mt-4
              .avatar-upload-wrapper
                %label.file
                  = f.file_field :image, class: "avatar-upload-field", accept: ImageUploader.permitted_extensions.join(",")
                  %span.file-custom
                    %span.file-upload-text Choose file
                  = f.hidden_field :image_cache
            .col-sm-6.mt-4
              = submit_tag "Create parking notification!", class: "btn btn-success parkingLocation-submit-btn", disabled: true

          .row.mt-4
            .col-md-6#choseLocationMethod
              %span.less-strong.waitingOnLocationText.hideOnLocationFind.collapse.in
                = translation(".waiting_on_device_location")
              .use-entered-address-radios.showOnLocationFind.collapse.mb-2
                .radio
                  %label
                    = f.radio_button :use_entered_address, false
                    Use current location
                .radio
                  %label
                    = f.radio_button :use_entered_address, true
                    Enter address manually

              .form-group.address-group.related-fields.collapse
                .ifManualRequired
                  = f.text_field :street, placeholder: translation(".address_or_intersection"), class: "form-control"

                .ifManualRequired
                  = f.text_field :city, placeholder: translation(".city"), class: "form-control"

                .row.countrystatezip
                  .col-sm-4.fancy-select.unfancy.no-restore-on-backspace.hidden-other{class: (@parking_notification.country_id == Country.united_states_id ? "unhidden" : "")}
                    = f.collection_select(:state_id, State.united_states, :id, :name, {include_blank: true, prompt: translation(".state")}, {class: "form-control"})
                  .col-sm-4
                    = f.text_field :zipcode, placeholder: translation(".zipcode"), class: "form-control"
                  .col-sm-4.fancy-select.unfancy.no-restore-on-backspace.ifManualRequired#us_id_data{data: {usid: Country.united_states_id}}
                    = f.select(:country_id, Country.select_options,
                      {prompt: translation(".choose_country")},
                      {class: 'country-select-input form-control'} )
            .col-md-6
              .form-group.less-strong
                = f.label :internal_notes, translation(".parking_notification_notes_html", org_name: @organization.short_name).html_safe
                = f.text_area :internal_notes, class: "form-control"

- if show_sticker_modal?
  - sticker_modal_body = helpers.capture_haml do
    .modal-body
      = form_for BikeSticker.new, {url: organization_sticker_path(id: "code", organization_id: @organization.to_param), action: "update", method: "PUT"} do |f|
        = f.hidden_field :bike_id, value: @bike.id
        .form-group
          = f.label :code, translation(".sticker_code"), class: "org-form-label"
          = f.text_field :code, required: true, class: "form-control"
        .modal-btn-footer
          .form-submit-button
            = f.submit translation(".assign_sticker"), class: "btn btn-success btn-lg"

  = render partial: "shared/modal", locals: {title: translation(".assign_sticker"), modal_body: sticker_modal_body, id: "assignStickerModal"}
