%header.with-subtitle.padded
  %h1
    #{ link_to @organization.name, admin_organization_path(@organization) } Invoices
  = link_to "New Invoice", new_admin_organization_invoice_path(organization_id: @organization.to_param), class: "button-green sharing-links"

%section.full-screen-table
  %table.table.table-striped.table-bordered
    %thead
      %th
        \#
      %th
        Start
      %th
        End
      %th
        Due
      %th
        Discount
      %th
        Paid
      %th
        Features
    %tbody
      - @organization.invoices.each do |invoice|
        %tr
          %td
            = link_to invoice.display_name, edit_admin_organization_invoice_path(organization_id: @organization.to_param, id: invoice.to_param)
          %td
            - if invoice.subscription_start_at.present?
              %span.convertTime
                = l invoice.subscription_start_at, format: :convert_time
          %td
            - if invoice.subscription_end_at.present?
              %span.convertTime
                = l invoice.subscription_end_at, format: :convert_time
          %td
            = invoice.amount_due_formatted
          %td
            = invoice.discount_formatted
          %td
            = invoice.amount_paid_formatted
            - invoice.payments.each do |payment|
              %small
                = link_to payment.kind.humanize, edit_admin_payment_path(payment)
          %td
            %ul
              - invoice.paid_features.each do |paid_feature|
                %li
                  = link_to paid_feature.name, edit_admin_paid_feature_path(paid_feature)
                  %em
                    = paid_feature.kind


%h2
  #{@organization.name} has #{pluralize(@organization.payments.count, "payment")}

%p.less-strong
  You can add invoices to payments by editing them. If you don't see a payment in this list, #{link_to "search the payments", admin_payments_path } and add it by editing it.

%section.full-screen-table
  %table.table.table-striped.table-bordered
    %thead
      %th
        Paid&nbsp;at
      %th
        User
      %th
        Invoice
      %th
        Kind
      %th
        Amount
    %tbody
      - @organization.payments.each do |payment|
        %tr
          %td
            %a.convertTime{ href: edit_admin_payment_path(payment) }
              = l payment.created_at, format: :convert_time
          %td
            - if payment.user_id.present?
              = link_to payment.user.display_name, edit_admin_user_path(payment.user)
            - elsif payment.email.present?
              = payment.email
              %small.less-strong
                no user
          %td
            - if payment.invoice_id.present?
              %span.convertTime
                = l payment.invoice.created_at, format: :convert_time
              = link_to payment.invoice.display_name, edit_admin_organization_invoice_path(organization_id: @organization.to_param, id: payment.invoice.to_param)
          %td
            %small
              = payment.kind.humanize
          %td
            = payment.amount_formatted
