.admin-subnav
  .col-md-6
    %h1
      Bulk Imports
  .col-md-6
    %ul
      %li.nav-item.dropdown
        %a.nav-link.dropdown-toggle{ href: "#", role: "button", "data-toggle" => "dropdown", "aria-haspopup" => "true", "aria-expanded" => "false", class: (@progress != "all" ? "active" : "") }
          #{@progress.titleize} #{@progress == "all" ? "progresses" : ""}
        .dropdown-menu
          = link_to "All progresses", url_for(sortable_search_params.merge(search_progress: nil)), class: "dropdown-item #{@progress == 'all' ? 'active' : '' }"
          .dropdown-divider
          - BulkImport.progresses.each do |progress|
            = link_to progress.humanize, url_for(sortable_search_params.merge(search_progress: progress)), class: "dropdown-item #{@progress == progress ? 'active' : '' }"
      %li.nav-item
        - all_active = (params.keys & %w[ascend not_ascend organization_id]).blank?
        = link_to "All", admin_bulk_imports_path(sortable_search_params), class: "nav-link #{all_active ? 'active' : ''}"
      %li.nav-item
        = link_to "Only Ascend", admin_bulk_imports_path(sortable_search_params.merge(ascend: true)), class: "nav-link #{params[:ascend].present? ? 'active' : ''}"
      %li.nav-item
        = link_to "Not Ascend", admin_bulk_imports_path(sortable_search_params.merge(not_ascend: true)), class: "nav-link #{params[:not_ascend].present? ? 'active' : ''}"
      %li.nav-item
        = link_to "New bulk import", new_admin_bulk_import_url, class: "nav-link"

  = render partial: "/shared/admin_current_header", locals: { viewing: "Bulk imports" }

= column_chart time_range_counts(collection: matching_bulk_imports), stacked: true, thousands: ","

.mt-4
  = render partial: "/shared/period_select"

= render partial: "/shared/pagination", locals: {collection: @bulk_imports}

.full-screen-table.pt-2
  %table.table.table-striped.table-bordered.sortable
    %thead.thead-light
      %th
        = sortable "created_at"
      %th
        = sortable "progress"
      %th
        Errors
      %th
        = sortable "user_id", "Creator"
      %th
        Organization & file
      %th
        Bikes
    %tbody
      - @bulk_imports.each do |bulk_import|
        - cache(bulk_import) do
          %tr
            %td
              %a.convertTime{ href: admin_bulk_import_url(bulk_import) }
                = l bulk_import.created_at, format: :convert_time
              - if bulk_import.organization_id.present?
                %small.less-strong
                  = link_to "org view", organization_bulk_import_path(bulk_import, organization_id: bulk_import.organization.to_param), class: "em less-strong"
            %td
              - bulk_import_progress_class = bulk_import.progress == "finished" ? "text-success" : ""
              %span{ class: bulk_import_progress_class }
                = bulk_import.progress
            %td
              - if bulk_import.line_import_errors.present?
                <span class="text-danger">Line</span>
              - if bulk_import.file_import_errors.present?
                <span class="text-danger">File!</span>
            %td
              - if bulk_import.user_id.present?
                = bulk_import.user.display_name
              - if bulk_import.ascend?
                %small.less-strong
                  ascend
                - if bulk_import.ascend_unprocessable?
                  %span.text-danger
                    Missing Ascend Organization!
            %td
              - if bulk_import.organization.present?
                = link_to bulk_import.organization.name, admin_bulk_imports_url(sortable_search_params.merge(organization_id: bulk_import.organization.to_param))
              - else
                = link_to "none", admin_bulk_imports_url(organization_id: "none"), style: "color: #ccc"
              %small
                - if bulk_import.file_cleaned?
                  %em.text-warning file removed
                - else
                  = bulk_import.file_filename
            %td
              = admin_number_display bulk_import.ownerships.count # Don't need to do bikes through ownerships
